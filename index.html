<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LBBD COMMUNITY</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0a0a25, #250a45);
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        canvas#particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.5;
        }

        .splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #8a00ff, #c200ff);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeOut 1s ease-in-out 3s forwards;
        }

        .splash h1 {
            font-size: 8vw;
            text-transform: uppercase;
            letter-spacing: 0.7rem;
            background: linear-gradient(45deg, #fff, #ffd700);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: pulse 1s infinite;
            text-shadow: 0 0 40px rgba(255, 255, 255, 0.9), 0 0 15px #ffd700;
        }

        .splash p {
            position: absolute;
            bottom: 2rem;
            font-size: 1rem;
            color: #ffd700;
            opacity: 0.9;
            animation: slideUp 1s ease-in-out;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }
        @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 0.9; } }

        .app {
            max-width: 600px;
            margin: 2rem auto 7rem;
            padding: 1.5rem;
            opacity: 0;
            animation: fadeIn 1s ease-in-out 3.5s forwards;
        }

        @keyframes fadeIn { to { opacity: 1; } }

        .page {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            backdrop-filter: blur(25px);
            box-shadow: 0 12px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideIn 0.7s ease-in-out;
            transition: transform 0.4s;
        }

        .page.active { display: block; }

        @keyframes slideIn { from { transform: translateY(80px) scale(0.9); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        h2 {
            font-size: 1.7rem;
            margin-bottom: 1.3rem;
            color: #ffd700;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .balance-page p {
            font-size: 2.3rem;
            font-weight: bold;
            background: linear-gradient(45deg, #ffd700, #fff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        .balance-page p:nth-child(3),
        .invite-page p,
        .withdraw-page p,
        .about-page p,
        .admin-page p {
            font-size: 1rem;
            color: #e6e6ff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .about-page a {
            color: #ffd700;
            text-decoration: none;
            transition: color 0.3s, text-shadow 0.3s;
        }

        .about-page a:hover {
            color: #fff;
            text-shadow: 0 0 12px #ffd700;
        }

        button {
            background: linear-gradient(45deg, #8a00ff, #c200ff);
            border: none;
            padding: 0.8rem 1.8rem;
            color: #fff;
            font-size: 1rem;
            border-radius: 30px;
            cursor: pointer;
            position: relative;
            transform: translateZ(0);
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, #6a00cc, #a100cc);
            border-radius: 30px;
            transform: translateZ(-20px);
            z-index: -1;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.6);
            transition: transform 0.3s;
        }

        button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
            z-index: 0;
        }

        button:hover {
            transform: translateY(-6px) translateZ(25px) rotateX(12deg);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
        }

        button:hover::before {
            transform: translateY(4px) translateZ(-15px);
        }

        button:active::after {
            width: 200px;
            height: 200px;
            transition: width 0.4s ease-out, height 0.4s ease-out;
        }

        button:active {
            transform: translateY(0) translateZ(0) scale(0.95);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        button:focus,
        button:active {
            outline: none;
            -webkit-tap-highlight-color: transparent;
            background: linear-gradient(45deg, #8a00ff, #c200ff);
        }

        .invite-page .action-button,
        .withdraw-page .action-button {
            display: block;
            margin: 2rem auto 0;
            padding: 1.1rem 2.2rem;
            font-size: 1.2rem;
            box-shadow: 0 10px 30px rgba(138, 0, 255, 0.6);
        }

        .invite-page .action-button::before,
        .withdraw-page .action-button::before {
            box-shadow: 0 10px 30px rgba(138, 0, 255, 0.7);
        }

        input {
            width: 100%;
            padding: 0.9rem;
            margin: 0.7rem 0;
            border-radius: 15px;
            border: none;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            color: #e6e6ff;
            font-size: 1rem;
            box-shadow: inset 0 4px 10px rgba(0, 0, 0, 0.4), 0 0 15px rgba(138, 0, 255, 0.3);
            transition: box-shadow 0.3s, transform 0.3s;
        }

        select {
            width: 100%;
            padding: 0.9rem;
            margin: 0.7rem 0;
            border-radius: 15px;
            border: 1px solid rgba(138, 0, 255, 0.5);
            background: linear-gradient(45deg, rgba(40, 10, 80, 0.9), rgba(80, 20, 120, 0.7));
            color: #ffd700;
            font-size: 1rem;
            box-shadow: inset 0 4px 10px rgba(0, 0, 0, 0.5), 0 0 20px rgba(138, 0, 255, 0.4);
            transition: box-shadow 0.3s, transform 0.3s, border-color 0.3s;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23ffd700" d="M2 4l4 4 4-4H2z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 12px;
            cursor: pointer;
        }

        select:focus, input:focus {
            outline: none;
            box-shadow: inset 0 4px 10px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 215, 0, 0.7);
            transform: scale(1.02);
            border-color: #ffd700;
        }

        select:hover {
            box-shadow: inset 0 4px 10px rgba(0, 0, 0, 0.5), 0 0 25px rgba(255, 215, 0, 0.5);
            border-color: #ffd700;
        }

        select option {
            background: #0a0a25;
            color: #fff;
            font-size: 1rem;
            padding: 0.5rem;
        }

        select option[value="bKash"] { color: #ff4d4d; }
        select option[value="Nagad"] { color: #00cc00; }
        select option[value="Binance"] { color: #f0b90b; }
        select option[value="Crypto"] { color: #00b7eb; }

        input::placeholder { color: #ccc; opacity: 0.8; }
        input#amount.invalid { box-shadow: inset 0 4px 10px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 0, 0, 0.7); }

        input:focus::after {
            content: '';
            position: absolute;
            width: 2px;
            height: 1.2rem;
            background: #ffd700;
            animation: cursorGlow 1s infinite;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
        }

        @keyframes cursorGlow { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(0, 0, 0, 0.95);
            padding: 2rem;
            border-radius: 30px;
            text-align: center;
            z-index: 2000;
            backdrop-filter: blur(20px);
            box-shadow: 0 15px 60px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.25);
            animation: popupShow 0.5s ease-in-out forwards;
        }

        .popup p { margin-bottom: 1.3rem; font-size: 1rem; color: #e6e6ff; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); }
        .popup input { margin-bottom: 1rem; }
        @keyframes popupShow { to { transform: translate(-50%, -50%) scale(1); } }
        .popup button { padding: 0.7rem 1.3rem; }

        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(25px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.7rem;
            box-shadow: 0 -6px 30px rgba(0, 0, 0, 0.5);
            z-index: 100;
        }

        .nav button {
            flex: 1;
            margin: 0 0.2rem;
            padding: 0.8rem;
            font-size: 0.85rem;
            text-align: center;
            white-space: nowrap;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
        }

        .nav.admin-active button {
            flex: 0.8;
            font-size: 0.75rem;
            padding: 0.6rem;
        }

        .notice {
            text-align: center;
            font-size: 0.9rem;
            color: #e6e6ff;
            opacity: 0.9;
            margin-top: 1.5rem;
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            text-shadow: 0 0 10px rgba(138, 0, 255, 0.5);
        }

        .notice span { display: inline-block; animation: slideRightToLeft 20s linear infinite; }
        .notice::before { left: 0; background: linear-gradient(to right, rgba(10, 10, 37, 1), transparent); }
        .notice::after { right: 0; background: linear-gradient(to left, rgba(10, 10, 37, 1), transparent); }
        @keyframes slideRightToLeft { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        .admin-page .user-list, .admin-page .withdraw-list { margin-top: 1rem; }
        .admin-page .user-item, .admin-page .withdraw-item {
            background: rgba(255, 251, 255, 0.05);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-page .user-item p, .admin-page .withdraw-item p { margin: 0.5rem 0; }
        .admin-page .user-item button, .admin-page .withdraw-item button {
            margin: 0.3rem 0.5rem 0 0;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        @media (max-width: 600px) {
            .splash h1 { font-size: 6vw; }
            .splash p { font-size: 0.8rem; }
            h2 { font-size: 1.4rem; }
            .balance-page p { font-size: 1.8rem; }
            .balance-page p:nth-child(3), .invite-page p, .withdraw-page p, .about-page p, .admin-page p { font-size: 0.9rem; }
            button { font-size: 0.9rem; padding: 0.7rem 1.3rem; }
            .invite-page .action-button, .withdraw-page .action-button { font-size: 1.1rem; padding: 0.9rem 1.8rem; }
            select, input { font-size: 0.9rem; }
            .nav button { font-size: 0.8rem; padding: 0.6rem; }
            .nav.admin-active button { font-size: 0.7rem; padding: 0.5rem; }
            .popup p { font-size: 0.9rem; }
            .notice { font-size: 0.8rem; }
            .admin-page .user-item button, .admin-page .withdraw-item button { font-size: 0.8rem; padding: 0.5rem 0.8rem; }
        }

        @media (max-width: 400px) {
            .nav { flex-direction: column; align-items: center; }
            .nav button { margin: 0.5rem 0; width: 90%; }
            .app { padding: 1rem; margin-bottom: 10rem; }
        }
    </style>
</head>
<body>
    <canvas id="particles"></canvas>
    <div class="splash" id="splash">
        <h1>LBBD COMMUNITY</h1>
        <p>@Developed by LBBD COMMUNITY</p>
    </div>
    <div class="app" id="app">
        <div class="page balance-page" id="balance">
            <h2>Your Balance</h2>
            <p id="balance-amount">0 Coins</p>
            <p>Current coin value: To be announced soon!</p>
        </div>
        <div class="page invite-page" id="invite">
            <h2>Invite Friends</h2>
            <p>Share your unique referral link and earn 1 coin per friend who joins!</p>
            <p id="referral-link">Generating your link...</p>
            <p id="friends-invited">Friends Invited: 0</p>
            <p id="invite-status"></p>
            <button class="action-button" onclick="shareTelegram()">Share Telegram Community</button>
        </div>
        <div class="page withdraw-page" id="withdraw">
            <h2>Withdraw Coins</h2>
            <p>Minimum withdrawal amount: To be announced soon!</p>
            <select id="method">
                <option value="bKash">bKash</option>
                <option value="Nagad">Nagad</option>
                <option value="Binance">Binance</option>
                <option value="Crypto">Crypto</option>
            </select>
            <input type="number" id="amount" placeholder="Enter amount" min="1" onkeypress="restrictToNumbers(event)">
            <input type="text" id="details" placeholder="Enter payment details">
            <p id="withdraw-status"></p>
            <button class="action-button" onclick="withdraw()">Submit Withdrawal</button>
        </div>
        <div class="page about-page" id="about">
            <h2>About LBBD Community</h2>
            <p>
                LBBD COMMUNITY is pioneering the Tap-2-Earn revolution in Bangladesh, inspired by projects like Hamster Kombat.
                Our mission is to empower users through innovative, rewarding, and engaging platforms.
                This referral web app is just the beginning — join us to support our journey and unlock exciting Tap-2-Earn bots and more!
            </p>
            <p>Join our Telegram: <a href="https://t.me/LBBD_MINING_OFFICIAL" target="_blank">t.me/LBBD_MINING_OFFICIAL</a></p>
            <div class="notice">
                <span>Like Hamster Kombat and other Tap-2-Earn projects, LBBD COMMUNITY is launching Tap-2-Earn bots in Bangladesh. This referral web app is just our first step — support us and more will come!</span>
            </div>
        </div>
        <div class="page admin-page" id="admin">
            <h2>Admin Panel</h2>
            <p id="admin-access-message"></p>
            <div class="user-list" id="user-list"></div>
            <h2>Withdraw Requests</h2>
            <div class="withdraw-list" id="withdraw-list"></div>
        </div>
    </div>
    <div class="nav" id="nav">
        <button id="nav-balance">Balance</button>
        <button id="nav-invite">Invite Friends</button>
        <button id="nav-withdraw">Withdraw</button>
        <button id="nav-about">About</button>
        <button id="nav-admin">Admin</button>
    </div>
    <div class="popup" id="popup" style="display: none;">
        <p id="popup-message"></p>
        <input type="password" id="admin-password" placeholder="Enter admin password" style="display: none;">
        <button id="popup-ok" onclick="closePopup()">OK</button>
        <button id="admin-submit" onclick="checkAdminPassword()" style="display: none;">Submit</button>
    </div>
    <script>
        let db = null;
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyDdYyNNk7FxUptu40Riumr2ZcftMglPMVk",
                authDomain: "lbbd-community-658cd.firebaseapp.com",
                projectId: "lbbd-community-658cd",
                storageBucket: "lbbd-community-658cd.firebasestorage.app",
                messagingSenderId: "1036805634476",
                appId: "1:1036805634476:web:7db1862c7acc8fd7796209"
            };
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showPopup('Error initializing Firebase. Check console for details.');
        }

        const canvas = document.getElementById('particles');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const particles = [];
        for (let i = 0; i < 200; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                radius: Math.random() * 3 + 1,
                vx: Math.random() * 0.7 - 0.35,
                vy: Math.random() * 0.7 - 0.35,
                color: `hsl(${Math.random() * 60 + 270}, 80%, 85%)`
            });
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.shadowBlur = 15;
                ctx.shadowColor = p.color;
                ctx.fill();
                p.x += p.vx;
                p.y += p.vy;
                if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
                if (p.y < 0 || p.y > canvas.height) p.vy *= -1;
            });
            ctx.shadowBlur = 0;
            requestAnimationFrame(animateParticles);
        }
        animateParticles();

        function restrictToNumbers(event) {
            const allowedKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'Backspace', 'Enter', 'ArrowLeft', 'ArrowRight', 'Delete'];
            if (!allowedKeys.includes(event.key)) {
                event.preventDefault();
                const input = event.target;
                input.classList.add('invalid');
                setTimeout(() => input.classList.remove('invalid'), 500);
            }
        }

        let balance = 0;
        let friendsInvited = 0;
        let currentUser = null;
        let referrerId = null;
        const telegramChannel = 'https://t.me/LBBD_MINING_OFFICIAL';
        const baseReferralUrl = 'https://lbbduser.github.io/lbbd-mini-app/?ref=';
        const adminPassword = 'hussainriyalbbd';
        let isAdminAuthenticated = false;

        function initTelegram() {
            const isTelegram = window.Telegram && window.Telegram.WebApp;
            if (!isTelegram) {
                showPopup('Please use this app within Telegram.');
                return false;
            }

            const Telegram = window.Telegram.WebApp;
            Telegram.ready();
            Telegram.expand();
            Telegram.enableClosingConfirmation();

            let attempts = 0;
            const maxAttempts = 10;
            const checkInterval = setInterval(() => {
                currentUser = Telegram.initDataUnsafe.user;
                if (currentUser && currentUser.id) {
                    showPopup(`Welcome! Your Telegram ID: ${currentUser.id}`);
                    clearInterval(checkInterval);
                    initializeUser();
                    checkReferral();
                } else if (attempts >= maxAttempts) {
                    showPopup('Unable to detect Telegram user ID after multiple attempts. Please reload the app.');
                    clearInterval(checkInterval);
                }
                attempts++;
            }, 500);
            return true;
        }

        function generateReferralCode(userId) {
            return btoa(userId).replace(/=/g, '').slice(0, 8);
        }

        async function initializeUser() {
            if (!currentUser || !db) {
                showPopup('Database not initialized. Please try again later.');
                return;
            }
            const userRef = db.collection('users').doc(currentUser.id.toString());
            const userDoc = await userRef.get();
            if (!userDoc.exists) {
                const referralCode = generateReferralCode(currentUser.id.toString());
                await userRef.set({
                    telegramId: currentUser.id,
                    username: currentUser.username || 'Anonymous',
                    coins: 0,
                    referralLink: `${baseReferralUrl}${referralCode}`,
                    invitedUsers: [],
                    isBanned: false,
                    withdrawalHistory: [],
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            const userData = (await userRef.get()).data();
            balance = userData.coins || 0;
            friendsInvited = userData.invitedUsers ? userData.invitedUsers.length : 0;
            document.getElementById('balance-amount').textContent = `${balance} Coins`;
            document.getElementById('referral-link').textContent = `Your referral link: ${userData.referralLink}`;
            document.getElementById('friends-invited').textContent = `Friends Invited: ${friendsInvited}`;
        }

        async function checkReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            const ref = urlParams.get('ref');
            if (ref && currentUser && currentUser.id) {
                try {
                    const decodedRef = atob(ref.padEnd((ref.length + 3) & ~3, '='));
                    if (decodedRef !== currentUser.id.toString()) {
                        referrerId = decodedRef;
                        await friendJoined(decodedRef);
                    }
                } catch (e) {
                    console.error('Error decoding referral:', e);
                }
            }
        }

        async function friendJoined(referrerId) {
            if (!db || !currentUser || !referrerId) {
                showPopup('Database not initialized or user not found.');
                return;
            }
            const userRef = db.collection('users').doc(currentUser.id.toString());
            const referrerRef = db.collection('users').doc(referrerId);
            const userDoc = await userRef.get();
            const referrerDoc = await referrerRef.get();

            if (!referrerDoc.exists) {
                console.log('Referrer not found');
                return;
            }

            const referrerData = referrerDoc.data();
            const userData = userDoc.exists ? userDoc.data() : { invitedBy: null };

            if (userData.invitedBy) {
                console.log('User already has a referrer');
                return;
            }

            const updatedInvited = [...new Set([...(referrerData.invitedUsers || []), currentUser.id])];
            await referrerRef.update({
                coins: (referrerData.coins || 0) + 1,
                invitedUsers: updatedInvited
            });

            await userRef.update({
                invitedBy: referrerId
            });

            if (referrerId === currentUser.id.toString()) {
                balance = (referrerData.coins || 0) + 1;
                friendsInvited = updatedInvited.length;
                document.getElementById('balance-amount').textContent = `${balance} Coins`;
                document.getElementById('friends-invited').textContent = `Friends Invited: ${friendsInvited}`;
            }

            document.getElementById('invite-status').textContent = `You joined via a referral! Referrer earned 1 coin.`;
            showPopup('Welcome! Your referrer earned 1 coin.');
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        document.getElementById('nav-balance').addEventListener('click', () => showPage('balance'));
        document.getElementById('nav-invite').addEventListener('click', () => showPage('invite'));
        document.getElementById('nav-withdraw').addEventListener('click', () => showPage('withdraw'));
        document.getElementById('nav-about').addEventListener('click', () => showPage('about'));
        document.getElementById('nav-admin').addEventListener('click', () => {
            if (isAdminAuthenticated) {
                showPage('admin');
                loadAdminPanel();
            } else {
                showAdminPasswordPrompt();
            }
        });

        function showAdminPasswordPrompt() {
            const popup = document.getElementById('popup');
            const popupMessage = document.getElementById('popup-message');
            const adminPasswordInput = document.getElementById('admin-password');
            const okButton = document.getElementById('popup-ok');
            const submitButton = document.getElementById('admin-submit');

            popupMessage.textContent = 'Enter Admin Password';
            adminPasswordInput.style.display = 'block';
            okButton.style.display = 'none';
            submitButton.style.display = 'block';

            popup.style.display = 'block';
            setTimeout(() => {
                popup.style.transform = 'translate(-50%, -50%) scale(1)';
            }, 10);
        }

        function checkAdminPassword() {
            const passwordInput = document.getElementById('admin-password').value;
            if (passwordInput === adminPassword) {
                isAdminAuthenticated = true;
                closePopup();
                showPage('admin');
                loadAdminPanel();
            } else {
                showPopup('Incorrect password. Please try again.');
            }
        }

        function showPopup(message) {
            const popup = document.getElementById('popup');
            const popupMessage = document.getElementById('popup-message');
            const adminPasswordInput = document.getElementById('admin-password');
            const okButton = document.getElementById('popup-ok');
            const submitButton = document.getElementById('admin-submit');

            popupMessage.textContent = message;
            adminPasswordInput.style.display = 'none';
            adminPasswordInput.value = '';
            okButton.style.display = 'block';
            submitButton.style.display = 'none';

            popup.style.display = 'block';
            setTimeout(() => {
                popup.style.transform = 'translate(-50%, -50%) scale(1)';
            }, 10);
        }

        function closePopup() {
            const popup = document.getElementById('popup');
            popup.style.transform = 'translate(-50%, -50%) scale(0)';
            setTimeout(() => {
                popup.style.display = 'none';
            }, 500);
        }

        function shareTelegram() {
            const referralLink = document.getElementById('referral-link').textContent.replace('Your referral link: ', '');
            const shareText = `Join LBBD COMMUNITY and earn rewards! Join our Telegram: ${telegramChannel} Use my referral link: ${referralLink}`;
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(telegramChannel)}&text=${encodeURIComponent(shareText)}`;
            window.open(shareUrl, '_blank');
            document.getElementById('invite-status').textContent = 'Invite sent! Waiting for friend to join...';
        }

        const methodSelect = document.getElementById('method');
        const detailsInput = document.getElementById('details');
        methodSelect.addEventListener('change', () => {
            const selectedMethod = methodSelect.value;
            detailsInput.value = `${selectedMethod}: `;
            detailsInput.placeholder = `Enter ${selectedMethod} details`;
        });

        detailsInput.addEventListener('input', () => {
            const selectedMethod = methodSelect.value;
            if (!detailsInput.value.startsWith(`${selectedMethod}: `)) {
                detailsInput.value = `${selectedMethod}: ` + detailsInput.value;
            }
        });

        async function withdraw() {
            if (!currentUser || !db) {
                showPopup('Database not initialized or user not found.');
                return;
            }
            if (balance === 0) {
                showPopup('You have no coins to withdraw!');
                return;
            }

            const amount = document.getElementById('amount').value;
            const method = document.getElementById('method').value;
            const details = document.getElementById('details').value;

            if (!amount || !details || details === `${method}: `) {
                showPopup('Please fill all fields.');
                return;
            }

            if (amount > balance) {
                showPopup('Insufficient balance.');
                return;
            }

            await db.collection('withdraw_requests').add({
                telegramId: currentUser.id,
                username: currentUser.username || 'Anonymous',
                amount: parseInt(amount),
                method,
                details,
                status: 'Pending',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            balance -= amount;
            const userRef = db.collection('users').doc(currentUser.id.toString());
            await userRef.update({
                coins: balance,
                withdrawalHistory: firebase.firestore.FieldValue.arrayUnion({
                    amount: parseInt(amount),
                    method,
                    details,
                    status: 'Pending',
                    timestamp: new Date().toISOString()
                })
            });

            document.getElementById('withdraw-status').textContent = 'Withdrawal Pending - Please wait 24 hours.';
            document.getElementById('balance-amount').textContent = `${balance} Coins`;
            document.getElementById('amount').value = '';
            document.getElementById('details').value = `${method}: `;
        }

        async function loadAdminPanel() {
            if (!isAdminAuthenticated || !db) {
                document.getElementById('admin-access-message').textContent = 'Access denied: Admin only.';
                return;
            }
            document.getElementById('admin-access-message').textContent = 'Welcome, Admin!';

            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            const usersSnapshot = await db.collection('users').get();
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <p>Telegram ID: ${user.telegramId}</p>
                    <p>Username: ${user.username}</p>
                    <p>Coins: ${user.coins}</p>
                    <p>Referral Link: ${user.referralLink}</p>
                    <p>Invited Users: ${user.invitedUsers ? user.invitedUsers.join(', ') : 'None'}</p>
                    <p>Status: ${user.isBanned ? 'Banned' : 'Active'}</p>
                    <p>Withdrawal History: ${user.withdrawalHistory ? user.withdrawalHistory.map(w => `${w.amount} coins via ${w.method} (${w.status})`).join(', ') : 'None'}</p>
                    <button onclick="adjustCoins('${doc.id}', 10)">+10 Coins</button>
                    <button onclick="adjustCoins('${doc.id}', -10)">-10 Coins</button>
                    <button onclick="resetReferralLink('${doc.id}')">Reset Referral Link</button>
                    <button onclick="toggleBan('${doc.id}', ${user.isBanned})">${user.isBanned ? 'Unban' : 'Ban'}</button>
                `;
                userList.appendChild(userItem);
            });

            const withdrawList = document.getElementById('withdraw-list');
            withdrawList.innerHTML = '';
            const withdrawSnapshot = await db.collection('withdraw_requests').get();
            withdrawSnapshot.forEach(doc => {
                const request = doc.data();
                const withdrawItem = document.createElement('div');
                withdrawItem.className = 'withdraw-item';
                withdrawItem.innerHTML = `
                    <p>Username: ${request.username}</p>
                    <p>Amount: ${request.amount} Coins</p>
                    <p>Method: ${request.method}</p>
                    <p>Details: ${request.details}</p>
                    <p>Status: ${request.status}</p>
                    <p>Time: ${request.timestamp ? new Date(request.timestamp.toDate()).toLocaleString() : 'N/A'}</p>
                    <button onclick="updateWithdrawStatus('${doc.id}', 'Paid')">Mark as Paid</button>
                    <button onclick="updateWithdrawStatus('${doc.id}', 'Cancelled')">Mark as Cancelled</button>
                `;
                withdrawList.appendChild(withdrawItem);
            });
        }

        async function adjustCoins(userId, amount) {
            if (!db) {
                showPopup('Database not initialized.');
                return;
            }
            const userRef = db.collection('users').doc(userId);
            await userRef.update({ coins: firebase.firestore.FieldValue.increment(amount) });
            loadAdminPanel();
            showPopup(`Adjusted coins by ${amount} for user ${userId}`);
        }

        async function resetReferralLink(userId) {
            if (!db) {
                showPopup('Database not initialized.');
                return;
            }
            const newCode = generateReferralCode(userId);
            const userRef = db.collection('users').doc(userId);
            await userRef.update({ referralLink: `${baseReferralUrl}${newCode}` });
            loadAdminPanel();
            showPopup(`Reset referral link for user ${userId}`);
        }

        async function toggleBan(userId, isBanned) {
            if (!db) {
                showPopup('Database not initialized.');
                return;
            }
            const userRef = db.collection('users').doc(userId);
            await userRef.update({ isBanned: !isBanned });
            loadAdminPanel();
            showPopup(`User ${userId} ${isBanned ? 'unbanned' : 'banned'}`);
        }

        async function updateWithdrawStatus(requestId, status) {
            if (!db) {
                showPopup('Database not initialized.');
                return;
            }
            const requestRef = db.collection('withdraw_requests').doc(requestId);
            const request = (await requestRef.get()).data();
            await requestRef.update({ status });
            const userRef = db.collection('users').doc(request.telegramId.toString());
            const user = (await userRef.get()).data();
            const updatedHistory = user.withdrawalHistory.map(w => 
                w.timestamp === request.timestamp.toDate().toISOString() ? { ...w, status } : w
            );
            await userRef.update({ withdrawalHistory: updatedHistory });
            loadAdminPanel();
            showPopup(`Withdrawal request marked as ${status}`);
        }

        setTimeout(() => {
            document.getElementById('splash').remove();
            showPage('balance');
            initTelegram();
        }, 4000);

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    </script>
</body>
</html>
