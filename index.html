<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LBBD COMMUNITY</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        html, body {
            height: 100%;
            overflow-x: hidden;
        }

        body {
            background: linear-gradient(135deg, #0a0a25, #250a45);
            color: #fff;
            min-height: 100vh;
            position: relative;
            margin: 0;
            padding: 0;
        }

        canvas#particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            opacity: 0.5;
        }

        .splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #8a00ff, #c200ff);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 1000;
            animation: fadeOut 1s ease-in-out 3s forwards;
        }

        .splash h1 {
            font-size: clamp(2rem, 5vw, 4rem);
            text-transform: uppercase;
            letter-spacing: 0.5rem;
            background: linear-gradient(45deg, #fff, #ffd700);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: pulse 1s infinite;
            text-shadow: 0 0 40px rgba(255, 255, 255, 0.9), 0 0 15px #ffd700;
            margin-bottom: 1rem;
        }

        .splash a {
            font-size: clamp(1rem, 2.5vw, 1.5rem);
            color: #ffd700;
            text-decoration: none;
            transition: color 0.3s, text-shadow 0.3s;
        }

        .splash a:hover {
            color: #fff;
            text-shadow: 0 0 12px #ffd700;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

        .app {
            max-width: 1200px;
            margin: 2rem auto 7rem;
            padding: 1.5rem;
            opacity: 0;
            animation: fadeIn 1s ease-in-out 3.5s forwards;
        }

        @keyframes fadeIn { to { opacity: 1; } }

        .page {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            backdrop-filter: blur(25px);
            box-shadow: 0 12px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideIn 0.7s ease-in-out;
        }

        .page.active { display: block; }

        @keyframes slideIn { from { transform: translateY(80px) scale(0.9); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        h2 {
            font-size: clamp(1.4rem, 2.5vw, 2rem);
            margin-bottom: 1.3rem;
            color: #ffd700;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .balance-page p {
            font-size: clamp(1.8rem, 3vw, 2.5rem);
            font-weight: bold;
            background: linear-gradient(45deg, #ffd700, #fff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        .balance-page p:nth-child(3),
        .invite-page p,
        .withdraw-page p,
        .about-page p,
        .profile-page p,
        .admin-page p {
            font-size: clamp(0.9rem, 1.5vw, 1.2rem);
            color: #e6e6ff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .about-page a {
            color: #ffd700;
            text-decoration: none;
            transition: color 0.3s, text-shadow 0.3s;
        }

        .about-page a:hover {
            color: #fff;
            text-shadow: 0 0 12px #ffd700;
        }

        button {
            background: linear-gradient(45deg, #8a00ff, #c200ff);
            border: none;
            padding: clamp(0.6rem, 1vw, 0.8rem) clamp(1.3rem, 2vw, 1.8rem);
            color: #fff;
            font-size: clamp(0.8rem, 1.5vw, 1rem);
            border-radius: 30px;
            cursor: pointer;
            position: relative;
            transform: translateZ(0);
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, #6a00cc, #a100cc);
            border-radius: 30px;
            transform: translateZ(-20px);
            z-index: -1;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.6);
            transition: transform 0.3s;
        }

        button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
            z-index: 0;
        }

        button:hover {
            transform: translateY(-6px) translateZ(25px) rotateX(12deg);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
        }

        button:hover::before {
            transform: translateY(4px) translateZ(-15px);
        }

        button:active::after {
            width: 200px;
            height: 200px;
            transition: width 0.4s ease-out, height 0.4s ease-out;
        }

        button:active {
            transform: translateY(0) translateZ(0) scale(0.95);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        button:focus,
        button:active {
            outline: none;
            background: linear-gradient(45deg, #8a00ff, #c200ff);
        }

        .invite-page .action-button,
        .withdraw-page .action-button {
            display: block;
            margin: 2rem auto 0;
            padding: clamp(0.9rem, 1.5vw, 1.1rem) clamp(1.8rem, 2.5vw, 2.2rem);
            font-size: clamp(1rem, 1.8vw, 1.2rem);
            box-shadow: 0 10px 30px rgba(138, 0, 255, 0.6);
        }

        .invite-page .action-button::before,
        .withdraw-page .action-button::before {
            box-shadow: 0 10px 30px rgba(138, 0, 255, 0.7);
        }

        input, textarea {
            width: 100%;
            padding: clamp(0.7rem, 1vw, 0.9rem);
            margin: clamp(0.5rem, 0.8vw, 0.7rem) 0;
            border-radius: 15px;
            border: none;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            color: #e6e6ff;
            font-size: clamp(0.8rem, 1.2vw, 1rem);
            box-shadow: inset 0 4px 10px rgba(0, 0, 0, 0.4), 0 0 15px rgba(138, 0, 255, 0.3);
            transition: box-shadow 0.3s, transform 0.3s;
        }

        select {
            width: 100%;
            padding: clamp(0.7rem, 1vw, 0.9rem);
            margin: clamp(0.5rem, 0.8vw, 0.7rem) 0;
            border-radius: 15px;
            border: 1px solid rgba(138, 0, 255, 0.5);
            background: linear-gradient(45deg, rgba(40, 10, 80, 0.9), rgba(80, 20, 120, 0.7));
            color: #ffd700;
            font-size: clamp(0.8rem, 1.2vw, 1rem);
            box-shadow: inset 0 4px 10px rgba(0, 0, 0, 0.5), 0 0 20px rgba(138, 0, 255, 0.4);
            transition: box-shadow 0.3s, transform 0.3s, border-color 0.3s;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23ffd700" d="M2 4l4 4 4-4H2z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 12px;
            cursor: pointer;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            box-shadow: inset 0 4px 10px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 215, 0, 0.7);
            transform: scale(1.02);
            border-color: #ffd700;
        }

        select:hover {
            box-shadow: inset 0 4px 10px rgba(0, 0, 0, 0.5), 0 0 25px rgba(255, 215, 0, 0.5);
            border-color: #ffd700;
        }

        select option {
            background: #0a0a25;
            color: #fff;
            font-size: clamp(0.8rem, 1.2vw, 1rem);
            padding: 0.5rem;
        }

        select option[value="bKash"] { color: #ff4d4d; }
        select option[value="Nagad"] { color: #00cc00; }
        select option[value="Binance"] { color: #f0b90b; }
        select option[value="Crypto"] { color: #00b7eb; }

        input::placeholder, textarea::placeholder { color: #ccc; opacity: 0.8; }
        input#amount.invalid { box-shadow: inset 0 4px 10px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 0, 0, 0.7); }

        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(25px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding: clamp(0.5rem, 1vw, 0.7rem);
            box-shadow: 0 -6px 30px rgba(0, 0, 0, 0.5);
            z-index: 100;
        }

        .nav.admin-active button {
            flex: 0.8;
            font-size: clamp(0.6rem, 1vw, 0.75rem);
            padding: clamp(0.4rem, 0.8vw, 0.6rem);
        }

        .notice {
            text-align: center;
            font-size: clamp(0.7rem, 1vw, 0.9rem);
            color: #e6e6ff;
            opacity: 0.9;
            margin-top: 1.5rem;
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            text-shadow: 0 0 10px rgba(138, 0, 255, 0.5);
        }

        .notice::before,
        .notice::after {
            content: '';
            position: absolute;
            top: 0;
            width: 50px;
            height: 100%;
            z-index: 1;
        }

        .notice::before {
            left: 0;
            background: linear-gradient(to right, rgba(10, 10, 37, 1), transparent);
        }

        .notice::after {
            right: 0;
            background: linear-gradient(to left, rgba(10, 10, 37, 1), transparent);
        }

        .notice span {
            display: inline-block;
            animation: slideRightToLeft 20s linear infinite;
        }

        @keyframes slideRightToLeft { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        /* Admin Panel Specific Styles */
        .admin-page {
            max-height: calc(100vh - 150px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #ffd700 rgba(255, 255, 255, 0.1);
        }

        .admin-page::-webkit-scrollbar {
            width: 8px;
        }

        .admin-page::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .admin-page::-webkit-scrollbar-thumb {
            background: #ffd700;
            border-radius: 4px;
        }

        .admin-section {
            margin-bottom: 2rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-section h3 {
            font-size: clamp(1.2rem, 2vw, 1.5rem);
            color: #ffd700;
            margin-bottom: 1rem;
        }

        .admin-section .user-list,
        .admin-section .withdraw-list {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #ffd700 rgba(255, 255, 255, 0.1);
        }

        .admin-section .user-list::-webkit-scrollbar,
        .admin-section .withdraw-list::-webkit-scrollbar {
            width: 6px;
        }

        .admin-section .user-list::-webkit-scrollbar-track,
        .admin-section .withdraw-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .admin-section .user-list::-webkit-scrollbar-thumb,
        .admin-section .withdraw-list::-webkit-scrollbar-thumb {
            background: #ffd700;
            border-radius: 3px;
        }

        .admin-section .user-item,
        .admin-section .withdraw-item {
            background: rgba(255, 251, 255, 0.05);
            padding: clamp(0.8rem, 1.5vw, 1rem);
            margin-bottom: clamp(0.8rem, 1.5vw, 1rem);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-section .user-item select,
        .admin-section .withdraw-item select {
            width: 100%;
            margin-top: 0.5rem;
        }

        .admin-section .user-item p,
        .admin-section .withdraw-item p {
            margin: clamp(0.4rem, 0.7vw, 0.5rem) 0;
        }

        .admin-section .user-item button,
        .admin-section .withdraw-item button {
            margin: clamp(0.2rem, 0.4vw, 0.3rem) clamp(0.4rem, 0.7vw, 0.5rem) 0 0;
            padding: clamp(0.4rem, 0.7vw, 0.5rem) clamp(0.8rem, 1.5vw, 1rem);
            font-size: clamp(0.7rem, 1vw, 0.9rem);
        }

        .admin-section .user-item .coin-edit {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            align-items: center;
        }

        .admin-section .user-item .coin-edit input {
            width: 80px;
            padding: 0.5rem;
        }

        .admin-section .notice-form {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .admin-section .notice-form input {
            width: 70%;
        }

        .summary-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-section p {
            font-size: clamp(1rem, 1.5vw, 1.2rem);
            margin: 0.5rem 0;
        }

        /* Popup Styles */
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .popup {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2 Zing);
            text-align: center;
            animation: popupFadeIn 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 250px;
        }

        @keyframes popupFadeIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .popup h3 {
            font-size: clamp(1.2rem, 2vw, 1.5rem);
            color: #ffd700;
            margin-bottom: 1rem;
        }

        .popup input, .popup textarea {
            width: 100%;
            margin-bottom: 1rem;
        }

        .popup textarea {
            height: 100px;
            resize: none;
        }

        .popup .error-message {
            color: #ff4d4d;
            font-size: clamp(0.8rem, 1.2vw, 0.9rem);
            margin-top: 0.5rem;
            display: none;
        }

        .popup .button-group {
            display: flex;
            justify-content: space-around;
            gap: 1rem;
            margin-top: auto;
        }

        .popup button {
            flex: 1;
            padding: clamp(0.6rem, 1vw, 0.8rem) clamp(1.3rem, 2vw, 1.8rem);
            font-size: clamp(0.8rem, 1.5vw, 1rem);
            border-radius: 30px;
            cursor: pointer;
            background: linear-gradient(45deg, #8a00ff, #c200ff);
            color: #fff;
            border: none;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.5);
        }

        .popup button:hover {
            transform: translateY(-6px) translateZ(25px) rotateX(12deg);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
        }

        .popup button:active {
            transform: translateY(0) translateZ(0) scale(0.95);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #ffd700;
            border-top: 5px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app {
                padding: clamp(1rem, 2vw, 1.5rem);
                margin: 1rem 0.5rem 6rem;
                max-width: 100%;
            }
            .nav { padding: 0.5rem; }
            .nav button {
                font-size: clamp(0.6rem, 1.2vw, 0.8rem);
                padding: 0.5rem;
            }
            .admin-section .notice-form { flex-direction: column; }
            .admin-section .notice-form input { width: 100%; }
            .admin-section .user-item .coin-edit { flex-direction: column; }
            .admin-section .user-item .coin-edit input { width: 100%; }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .app {
                max-width: 800px;
                padding: 2rem;
            }
            .nav button {
                font-size: clamp(0.8rem, 1.2vw, 1rem);
                padding: 0.7rem;
            }
        }

        @media (min-width: 1025px) {
            .app {
                max-width: 1000px;
                padding: 2.5rem;
            }
            .nav button {
                font-size: clamp(0.9rem, 1.2vw, 1.1rem);
                padding: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
    </div>
    <canvas id="particles"></canvas>
    <div class="splash" id="splash">
        <h1>LBBD COMMUNITY</h1>
        <a href="https://t.me/earn_by_lbbd_bot" target="_blank">@earn_by_lbbd_bot</a>
    </div>
    <div class="app" id="app">
        <div class="page balance-page" id="balance">
            <h2>Your Balance</h2>
            <p id="balance-amount">0 Coins</p>
            <p>Current coin value: To be announced soon!</p>
            <button class="action-button" onclick="refreshData()">Refresh</button>
        </div>
        <div class="page invite-page" id="invite">
            <h2>Invite</h2>
            <p>Share your unique referral link and earn 1 coin per friend who joins @earn_by_lbbd_bot!</p>
            <p id="referral-link">Generating your link...</p>
            <p id="friends-invited">Friends Invited: 0</p>
            <p id="invite-status"></p>
            <button class="action-button" onclick="shareBot()">Share @earn_by_lbbd_bot</button>
            <button class="action-button" onclick="refreshData()">Refresh</button>
        </div>
        <div class="page withdraw-page" id="withdraw">
            <h2>Withdraw Coins</h2>
            <p>Minimum withdrawal amount: To be announced soon!</p>
            <select id="method">
                <option value="bKash">bKash</option>
                <option value="Nagad">Nagad</option>
                <option value="Binance">Binance</option>
                <option value="Crypto">Crypto</option>
            </select>
            <input type="number" id="amount" placeholder="Enter amount" min="1" onkeypress="restrictToNumbers(event)">
            <input type="text" id="details" placeholder="Enter payment details">
            <p id="withdraw-status"></p>
            <button class="action-button" onclick="withdraw()">Submit Withdrawal</button>
            <button class="action-button" onclick="refreshData()">Refresh</button>
        </div>
        <div class="page about-page" id="about">
            <h2>About LBBD Community</h2>
            <p>
                LBBD COMMUNITY is pioneering the Tap-2-Earn revolution in Bangladesh, inspired by projects like Hamster Kombat.
                Our mission is to empower users through innovative, rewarding, and engaging platforms.
                This referral web app is just the beginning â€” join us to support our journey and unlock exciting Tap-2-Earn bots and more!
            </p>
            <p>Join our bot: <a href="https://t.me/earn_by_lbbd_bot" target="_blank">@earn_by_lbbd_bot</a></p>
            <p>By using this app, you agree to our <a href="#terms">Terms of Service</a> and <a href="#privacy">Privacy Policy</a>.</p>
            <div class="notice">
                <span>Like Hamster Kombat, LBBD COMMUNITY is launching Tap-2-Earn with @earn_by_lbbd_bot. Join now!</span>
            </div>
            <button class="action-button" onclick="refreshData()">Refresh</button>
        </div>
        <div class="page profile-page" id="profile">
            <h2>Your Profile</h2>
            <p id="profile-username">Username: Loading...</p>
            <p id="profile-id">Telegram ID: Loading...</p>
            <p id="profile-joined">Joined: Loading...</p>
            <p id="profile-referral">Referral Link: Loading...</p>
            <h3>Coin Transaction History</h3>
            <div id="transaction-history" class="transaction-history"></div>
            <button class="action-button" onclick="refreshData()">Refresh</button>
        </div>
        <div class="page admin-page" id="admin">
            <h2>Admin Panel</h2>
            <button onclick="testFirestoreWrite()">Test Firestore Write</button>
            <p id="admin-access-message">Welcome, Admin!</p>
            <div class="summary-section">
                <h3>Dashboard Summary</h3>
                <p>Total Users: <span id="total-users">0</span></p>
                <p>Total Coins in Circulation: <span id="total-coins">0</span></p>
                <p>Pending Withdrawals: <span id="pending-withdrawals">0</span></p>
            </div>
            <div class="admin-section">
                <h3>User Management</h3>
                <div class="user-list" id="user-list"></div>
            </div>
            <div class="admin-section">
                <h3>Withdrawal Requests</h3>
                <div class="withdraw-list" id="withdraw-list"></div>
            </div>
            <div class="admin-section">
                <h3>Send Notice to All Users</h3>
                <div class="notice-form">
                    <input type="text" id="admin-notice" placeholder="Enter notice message">
                    <button onclick="sendNotice()">Send Notice</button>
                </div>
                <p id="notice-status"></p>
            </div>
            <button class="action-button" onclick="refreshData()">Refresh</button>
        </div>
    </div>
    <div class="nav" id="nav">
        <button id="nav-balance">Balance</button>
        <button id="nav-invite">Invite</button>
        <button id="nav-withdraw">Withdraw</button>
        <button id="nav-about">About</button>
        <button id="nav-profile">Profile</button>
        <button id="nav-admin">Admin</button>
    </div>
    <div class="popup-overlay" id="admin-popup">
        <div class="popup">
            <h3>Admin Access</h3>
            <input type="password" id="admin-password" placeholder="Enter admin password">
            <div class="button-group">
                <button onclick="checkAdminPassword()">Submit</button>
                <button onclick="closePopup()">Cancel</button>
            </div>
            <p class="error-message" id="admin-error">Incorrect password. Please try again.</p>
        </div>
    </div>
    <div class="popup-overlay" id="notice-popup">
        <div class="popup">
            <h3>Admin Notice</h3>
            <p id="notice-message"></p>
            <div class="button-group">
                <button onclick="closeNoticePopup()">Close</button>
            </div>
        </div>
    </div>
    <div class="popup-overlay" id="ban-confirm-popup">
        <div class="popup">
            <h3>Confirm Ban</h3>
            <p>Are you sure you want to ban this user?</p>
            <div class="button-group">
                <button onclick="confirmBan(true)">OK</button>
                <button onclick="confirmBan(false)">Cancel</button>
            </div>
        </div>
    </div>
    <div class="popup-overlay" id="ban-message-popup">
        <div class="popup">
            <h3>Ban Reason</h3>
            <p>Type a message explaining why this user is being banned:</p>
            <textarea id="ban-message-input" placeholder="Enter ban reason"></textarea>
            <div class="button-group">
                <button onclick="submitBanMessage()">Submit</button>
            </div>
        </div>
    </div>
    <div class="popup-overlay" id="unban-confirm-popup">
        <div class="popup">
            <h3>Confirm Unban</h3>
            <p>Are you sure you want to unban this user?</p>
            <div class="button-group">
                <button onclick="confirmUnban(true)">OK</button>
                <button onclick="confirmUnban(false)">Cancel</button>
            </div>
        </div>
    </div>
    <div class="popup-overlay" id="unban-message-popup">
        <div class="popup">
            <h3>Unban Message</h3>
            <p>Type a special message for this user:</p>
            <textarea id="unban-message-input" placeholder="Enter unban message"></textarea>
            <div class="button-group">
                <button onclick="submitUnbanMessage()">Submit</button>
            </div>
        </div>
    </div>
    <div class="popup-overlay" id="ban-notification-popup">
        <div class="popup">
            <h3>You Are Banned</h3>
            <p id="ban-notification-message"></p>
            <div class="button-group">
                <button onclick="closeBot()">Cancel</button>
            </div>
        </div>
    </div>
    <div class="popup-overlay" id="unban-notification-popup">
        <div class="popup">
            <h3>Congratulations!</h3>
            <p>You have been unbanned!</p>
            <p id="unban-notification-message"></p>
            <div class="button-group">
                <button onclick="closeUnbanNotification()">OK</button>
            </div>
        </div>
    </div>
    <div class="popup-overlay" id="add-coins-popup">
        <div class="popup">
            <h3>Add Coins</h3>
            <p>Enter the amount of coins to add:</p>
            <input type="number" id="add-coins-input" placeholder="Enter amount" min="1">
            <div class="button-group">
                <button onclick="submitAddCoins()">Submit</button>
                <button onclick="cancelAction()">Cancel</button>
            </div>
        </div>
    </div>
    <div class="popup-overlay" id="subtract-coins-popup">
        <div class="popup">
            <h3>Subtract Coins</h3>
            <p>Enter the amount of coins to subtract:</p>
            <input type="number" id="subtract-coins-input" placeholder="Enter amount" min="1">
            <p id="subtract-error" class="error-message" style="display: none;">Cannot subtract: User has 0 coins.</p>
            <div class="button-group">
                <button onclick="submitSubtractCoins()">Submit</button>
                <button onclick="cancelAction()">Cancel</button>
            </div>
        </div>
    </div>
    <div class="popup-overlay" id="withdraw-status-popup">
        <div class="popup">
            <h3>Withdrawal Status</h3>
            <p id="withdraw-status-message"></p>
            <div class="button-group">
                <button onclick="closeWithdrawStatusPopup()">Close</button>
            </div>
        </div>
    </div>
    <div class="popup-overlay" id="cancel-reason-popup">
        <div class="popup">
            <h3>Cancellation Reason</h3>
            <p>Type a message explaining why this withdrawal is being cancelled:</p>
            <textarea id="cancel-reason-input" placeholder="Enter cancellation reason"></textarea>
            <div class="button-group">
                <button onclick="submitCancelReason()">Submit</button>
                <button onclick="cancelAction()">Cancel</button>
            </div>
        </div>
    </div>
    <div class="popup-overlay" id="delete-confirm-popup">
        <div class="popup">
            <h3>Confirm Delete</h3>
            <p>Are you sure you want to delete this user? This action cannot be undone, and all user data will be lost.</p>
            <div class="button-group">
                <button onclick="confirmDelete(true)">OK</button>
                <button onclick="confirmDelete(false)">Cancel</button>
            </div>
        </div>
    </div>
    <script>
        let db = null;

        async function initializeFirebase() {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyDdYyNNk7FxUptu40Riumr2ZcftMglPMVk",
                    authDomain: "lbbd-community-658cd.firebaseapp.com",
                    projectId: "lbbd-community-658cd",
                    storageBucket: "lbbd-community-658cd.firebasestorage.app",
                    messagingSenderId: "1036805634476",
                    appId: "1:1036805634476:web:7db1862c7acc8fd7796209"
                };
                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log('Firebase initialized successfully');
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Firebase initialization error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('admin-access-message').textContent = 'Failed to initialize database. Please try again later.';
            }
        }

        const canvas = document.getElementById('particles');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const particles = [];
        for (let i = 0; i < 200; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                radius: Math.random() * 3 + 1,
                vx: Math.random() * 0.7 - 0.35,
                vy: Math.random() * 0.7 - 0.35,
                color: `hsl(${Math.random() * 60 + 270}, 80%, 85%)`
            });
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.shadowBlur = 15;
                ctx.shadowColor = p.color;
                ctx.fill();
                p.x += p.vx;
                p.y += p.vy;
                if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
                if (p.y < 0 || p.y > canvas.height) p.vy *= -1;
            });
            ctx.shadowBlur = 0;
            requestAnimationFrame(animateParticles);
        }
        animateParticles();

        function restrictToNumbers(event) {
            const allowedKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'Backspace', 'Enter', 'ArrowLeft', 'ArrowRight', 'Delete'];
            if (!allowedKeys.includes(event.key)) {
                event.preventDefault();
                const input = event.target;
                input.classList.add('invalid');
                setTimeout(() => input.classList.remove('invalid'), 500);
            }
        }

        let balance = 0;
        let friendsInvited = 0;
        let currentUser = null;
        let referrerId = null;
        const botLink = 'https://t.me/earn_by_lbbd_bot';
        const baseReferralUrl = 'https://lbbduser.github.io/lbbd-mini-app/?ref=';
        const adminPassword = 'hussainriyalbbd';
        let isAdminAuthenticated = false;
        let testUserCounter = 0;
        let selectedUserId = null;
        let selectedAction = null;
        let selectedWithdrawId = null;

        function initTelegram() {
            const isTelegram = window.Telegram && window.Telegram.WebApp;
            if (!isTelegram) {
                console.error('Telegram WebApp not detected.');
                document.getElementById('admin-access-message').textContent = 'Please use this app within Telegram.';
                document.getElementById('loading').style.display = 'none';
                return false;
            }

            const Telegram = window.Telegram.WebApp;
            Telegram.ready();
            Telegram.expand();
            Telegram.enableClosingConfirmation();
            console.log('Telegram WebApp initialized:', Telegram);

            let attempts = 0;
            const maxAttempts = 10;
            const checkInterval = setInterval(() => {
                currentUser = Telegram.initDataUnsafe.user;
                console.log('Checking for Telegram user, attempt:', attempts + 1, 'User:', currentUser);
                if (currentUser && currentUser.id) {
                    document.getElementById('admin-access-message').textContent = `Welcome! Your Telegram ID: ${currentUser.id}`;
                    clearInterval(checkInterval);
                    initializeUser();
                    checkReferral();
                    checkBanStatus();
                    document.getElementById('loading').style.display = 'none';
                } else if (attempts >= maxAttempts) {
                    console.error('Failed to detect Telegram user after', maxAttempts, 'attempts.');
                    document.getElementById('admin-access-message').textContent = 'Unable to detect Telegram user ID after multiple attempts. Please reload the app.';
                    clearInterval(checkInterval);
                    document.getElementById('loading').style.display = 'none';
                }
                attempts++;
            }, 500);
            return true;
        }

        async function checkBanStatus() {
            if (!currentUser || !db) return;
            const userRef = db.collection('users').doc(currentUser.id.toString());
            const userDoc = await userRef.get();
            const userData = userDoc.data();
            if (userData.isBanned) {
                document.getElementById('ban-notification-message').textContent = `You have been banned. Reason: ${userData.banMessage || 'No reason provided.'}`;
                document.getElementById('ban-notification-popup').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
                document.getElementById('nav').style.display = 'none';
            } else if (userData.unbanMessage && !userData.shownUnbanMessage) {
                document.getElementById('unban-notification-message').textContent = `Message from Admin: ${userData.unbanMessage}`;
                document.getElementById('unban-notification-popup').style.display = 'flex';
                await userRef.update({ shownUnbanMessage: true });
            }
        }

        function closeBot() {
            window.Telegram.WebApp.close();
        }

        function closeUnbanNotification() {
            document.getElementById('unban-notification-popup').style.display = 'none';
        }

        function generateReferralCode(userId) {
            return btoa(userId).replace(/=/g, '').slice(0, 8);
        }

        async function initializeUser() {
            if (!currentUser || !db) {
                console.error('User or DB not initialized:', { currentUser, db });
                document.getElementById('admin-access-message').textContent = 'Database not initialized. Please try again later.';
                document.getElementById('loading').style.display = 'none';
                return;
            }
            console.log('Initializing user with ID:', currentUser.id);
            const userRef = db.collection('users').doc(currentUser.id.toString());
            try {
                const userDoc = await userRef.get();
                if (!userDoc.exists) {
                    const referralCode = generateReferralCode(currentUser.id.toString());
                    await userRef.set({
                        telegramId: currentUser.id,
                        username: currentUser.username || 'Anonymous',
                        coins: 0,
                        referralLink: `${baseReferralUrl}${referralCode}`,
                        invitedUsers: [],
                        isBanned: false,
                        banMessage: '',
                        unbanMessage: '',
                        shownUnbanMessage: false,
                        withdrawalHistory: [],
                        notices: [],
                        shownNotices: [],
                        hasJoinedBot: false,
                        referralEvents: [],
                        transactionHistory: [],
                        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('User successfully initialized:', currentUser.id);
                } else {
                    console.log('User already exists:', currentUser.id);
                }
                const userData = (await userRef.get()).data();
                balance = userData.coins || 0;
                friendsInvited = userData.invitedUsers ? userData.invitedUsers.length : 0;
                document.getElementById('balance-amount').textContent = `${balance} Coins`;
                document.getElementById('referral-link').textContent = `Your referral link: ${userData.referralLink}`;
                document.getElementById('friends-invited').textContent = `Friends Invited: ${friendsInvited}`;
                await userRef.update({ hasJoinedBot: true });
                console.log('User data loaded:', userData);
                updateProfile(userData);

                await checkForNotices();
                await checkWithdrawStatus();
            } catch (error) {
                console.error('Error initializing user:', error);
                document.getElementById('admin-access-message').textContent = 'Error initializing user: ' + error.message;
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function checkReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            const ref = urlParams.get('ref');
            if (ref && currentUser && currentUser.id) {
                try {
                    const decodedRef = atob(ref.padEnd((ref.length + 3) & ~3, '='));
                    if (decodedRef !== currentUser.id.toString()) {
                        referrerId = decodedRef;
                        await verifyBotJoin(decodedRef);
                    }
                } catch (e) {
                    console.error('Error decoding referral:', e);
                    document.getElementById('invite-status').textContent = 'Invalid referral link.';
                }
            }
        }

        async function verifyBotJoin(referrerId) {
            if (!db || !currentUser || !referrerId) {
                document.getElementById('admin-access-message').textContent = 'Database or user not found.';
                return;
            }
            const userRef = db.collection('users').doc(currentUser.id.toString());
            const referrerRef = db.collection('users').doc(referrerId);
            const userDoc = await userRef.get();
            const referrerDoc = await referrerRef.get();

            if (!referrerDoc.exists) {
                console.log('Referrer not found');
                document.getElementById('invite-status').textContent = 'Referrer not found.';
                return;
            }

            const referrerData = referrerDoc.data();
            const userData = userDoc.exists ? userDoc.data() : { invitedBy: null };

            if (userData.invitedBy) {
                console.log('User already has a referrer');
                document.getElementById('invite-status').textContent = 'You have already been referred.';
                return;
            }

            if (!userData.hasJoinedBot) {
                document.getElementById('invite-status').textContent = 'Please join @earn_by_lbbd_bot to complete the referral.';
                return;
            }

            const updatedInvited = [...new Set([...(referrerData.invitedUsers || []), currentUser.id])];
            const referralEvent = {
                referredUserId: currentUser.id,
                referredUsername: currentUser.username || 'Anonymous',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                coinsAwarded: 1
            };

            await referrerRef.update({
                coins: (referrerData.coins || 0) + 1,
                invitedUsers: updatedInvited,
                referralEvents: firebase.firestore.FieldValue.arrayUnion(referralEvent)
            });

            await userRef.update({
                invitedBy: referrerId
            });

            if (referrerId === currentUser.id.toString()) {
                balance = (referrerData.coins || 0) + 1;
                friendsInvited = updatedInvited.length;
                document.getElementById('balance-amount').textContent = `${balance} Coins`;
                document.getElementById('friends-invited').textContent = `Friends Invited: ${friendsInvited}`;
            }

            document.getElementById('invite-status').textContent = `You joined via ${referrerData.username || 'a friend'}'s referral! They earned 1 coin.`;
            await referrerRef.update({
                notices: firebase.firestore.FieldValue.arrayUnion({
                    message: `Your friend ${currentUser.username || 'Anonymous'} joined via your referral link! You earned 1 coin.`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                })
            });
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (pageId === 'admin' && !isAdminAuthenticated) {
                showAdminPopup();
            } else if (pageId === 'profile') {
                loadProfile();
            }
        }

        function showAdminPopup() {
            document.getElementById('admin-popup').style.display = 'flex';
            document.getElementById('admin-password').value = '';
            document.getElementById('admin-error').style.display = 'none';
            document.getElementById('admin-password').focus();
        }

        function closePopup() {
            document.getElementById('admin-popup').style.display = 'none';
            showPage('balance');
        }

        async function checkForNotices() {
            if (!currentUser || !db) {
                console.error('Cannot check notices: User or DB not initialized.');
                return;
            }
            console.log('Checking for notices for user:', currentUser.id);
            const userRef = db.collection('users').doc(currentUser.id.toString());
            try {
                const userDoc = await userRef.get();
                const userData = userDoc.data();
                const notices = userData.notices || [];
                const shownNotices = userData.shownNotices || [];
                console.log('Notices:', notices, 'Shown Notices:', shownNotices);

                const newNotice = notices.find(notice => !shownNotices.includes(notice.timestamp?.toDate().toISOString()));
                if (newNotice) {
                    console.log('Displaying new notice:', newNotice);
                    document.getElementById('notice-message').textContent = newNotice.message;
                    document.getElementById('notice-popup').style.display = 'flex';
                    await userRef.update({
                        shownNotices: firebase.firestore.FieldValue.arrayUnion(newNotice.timestamp.toDate().toISOString())
                    });
                } else {
                    console.log('No new notices to display.');
                }
            } catch (error) {
                console.error('Error checking notices:', error);
            }
        }

        async function checkWithdrawStatus() {
            if (!currentUser || !db) return;
            const userRef = db.collection('users').doc(currentUser.id.toString());
            const userDoc = await userRef.get();
            const userData = userDoc.data();
            const withdrawalHistory = userData.withdrawalHistory || [];
            const shownStatuses = userData.shownWithdrawStatuses || [];

            for (const withdraw of withdrawalHistory) {
                const timestamp = withdraw.timestamp;
                if (!shownStatuses.includes(timestamp) && (withdraw.status === 'Paid' || withdraw.status === 'Cancelled')) {
                    let message = '';
                    if (withdraw.status === 'Paid') {
                        message = `Your withdrawal of ${withdraw.amount} coins via ${withdraw.method} has been paid!`;
                    } else {
                        message = `Your withdrawal of ${withdraw.amount} coins via ${withdraw.method} was cancelled. Reason: ${withdraw.cancelReason || 'No reason provided.'}`;
                    }
                    document.getElementById('withdraw-status-message').textContent = message;
                    document.getElementById('withdraw-status-popup').style.display = 'flex';
                    await userRef.update({
                        shownWithdrawStatuses: firebase.firestore.FieldValue.arrayUnion(timestamp)
                    });
                }
            }
        }

        function closeNoticePopup() {
            document.getElementById('notice-popup').style.display = 'none';
        }

        function closeWithdrawStatusPopup() {
            document.getElementById('withdraw-status-popup').style.display = 'none';
        }

        document.getElementById('nav-balance').addEventListener('click', () => showPage('balance'));
        document.getElementById('nav-invite').addEventListener('click', () => showPage('invite'));
        document.getElementById('nav-withdraw').addEventListener('click', () => showPage('withdraw'));
        document.getElementById('nav-about').addEventListener('click', () => showPage('about'));
        document.getElementById('nav-profile').addEventListener('click', () => showPage('profile'));
        document.getElementById('nav-admin').addEventListener('click', () => {
            if (isAdminAuthenticated) {
                showPage('admin');
            } else {
                showAdminPopup();
            }
        });

        function shareBot() {
            const referralLink = document.getElementById('referral-link').textContent.replace('Your referral link: ', '');
            const shareText = `Join @earn_by_lbbd_bot and earn rewards! Use my referral link: ${referralLink}`;
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(botLink)}&text=${encodeURIComponent(shareText)}`;
            window.open(shareUrl, '_blank');
            document.getElementById('invite-status').textContent = 'Invite sent! Waiting for friend to join @earn_by_lbbd_bot...';
        }

        const methodSelect = document.getElementById('method');
        const detailsInput = document.getElementById('details');
        methodSelect.addEventListener('change', () => {
            const selectedMethod = methodSelect.value;
            detailsInput.value = `${selectedMethod}: `;
            detailsInput.placeholder = `Enter ${selectedMethod} details`;
        });

        detailsInput.addEventListener('input', () => {
            const selectedMethod = methodSelect.value;
            if (!detailsInput.value.startsWith(`${selectedMethod}: `)) {
                detailsInput.value = `${selectedMethod}: ` + detailsInput.value;
            }
        });

        async function withdraw() {
            if (!currentUser || !db) {
                document.getElementById('admin-access-message').textContent = 'Database not initialized or user not found.';
                return;
            }
            if (balance === 0) {
                document.getElementById('withdraw-status').textContent = 'You have no coins to withdraw!';
                return;
            }

            const amount = document.getElementById('amount').value;
            const method = document.getElementById('method').value;
            const details = document.getElementById('details').value;

            if (!amount || !details || details === `${method}: `) {
                document.getElementById('withdraw-status').textContent = 'Please fill all fields.';
                return;
            }

            if (amount > balance) {
                document.getElementById('withdraw-status').textContent = 'Insufficient balance.';
                return;
            }

            await db.collection('withdraw_requests').add({
                telegramId: currentUser.id,
                username: currentUser.username || 'Anonymous',
                amount: parseInt(amount),
                method,
                details,
                status: 'Pending',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            balance -= amount;
            const userRef = db.collection('users').doc(currentUser.id.toString());
            await userRef.update({
                coins: balance,
                withdrawalHistory: firebase.firestore.FieldValue.arrayUnion({
                    amount: parseInt(amount),
                    method,
                    details,
                    status: 'Pending',
                    timestamp: new Date().toISOString(),
                    cancelReason: ''
                })
            });

            document.getElementById('withdraw-status').textContent = 'Withdrawal Pending - Please wait 24 hours.';
            document.getElementById('balance-amount').textContent = `${balance} Coins`;
            document.getElementById('amount').value = '';
            document.getElementById('details').value = `${method}: `;
        }

        async function loadAdminPanel() {
            if (!isAdminAuthenticated || !db) {
                document.getElementById('admin-access-message').textContent = 'Access denied: Admin only.';
                return;
            }
            document.getElementById('admin-access-message').textContent = 'Welcome, Admin!';

            await updateDashboardSummary();

            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            const usersSnapshot = await db.collection('users').get();
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                const userId = doc.id;
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <p>ID: ${userId} | Username: ${user.username || 'Anonymous'}</p>
                    <p>Coins: <span id="coin-${userId}">${user.coins || 0}</span> | Banned: ${user.isBanned ? 'Yes' : 'No'}</p>
                    <select id="user-select-${userId}" onchange="updateSelectedUser('${userId}', this.value)">
                        <option value="">Select Action</option>
                        <option value="ban">${user.isBanned ? 'Update Ban Reason' : 'Ban'}</option>
                        <option value="unban">${user.isBanned ? 'Unban' : '---'}</option>
                        <option value="addCoins">Add Coins</option>
                        <option value="subtractCoins">Subtract Coins</option>
                        <option value="delete">Delete User</option>
                    </select>
                `;
                userList.appendChild(userItem);
            });

            const withdrawList = document.getElementById('withdraw-list');
            withdrawList.innerHTML = '';
            const withdrawSnapshot = await db.collection('withdraw_requests').get();
            withdrawSnapshot.forEach(doc => {
                const withdraw = doc.data();
                const withdrawId = doc.id;
                const withdrawItem = document.createElement('div');
                withdrawItem.className = 'withdraw-item';
                withdrawItem.innerHTML = `
                    <p>ID: ${withdrawId} | User: ${withdraw.username || 'Anonymous'} (${withdraw.telegramId})</p>
                    <p>Amount: ${withdraw.amount} | Method: ${withdraw.method} | Details: ${withdraw.details}</p>
                    <p>Status: ${withdraw.status} | Requested: ${withdraw.timestamp.toDate().toLocaleString()}</p>
                    ${withdraw.status === 'Pending' ? `
                        <select onchange="updateSelectedWithdraw('${withdrawId}', this.value)">
                            <option value="">Select Action</option>
                            <option value="pay">Pay</option>
                            <option value="cancel">Cancel</option>
                        </select>
                    ` : ''}
                `;
                withdrawList.appendChild(withdrawItem);
            });
        }

        function updateSelectedUser(userId, action) {
            selectedUserId = userId;
            selectedAction = action;
            if (action === 'ban') {
                document.getElementById('ban-confirm-popup').style.display = 'flex';
            } else if (action === 'unban') {
                document.getElementById('unban-confirm-popup').style.display = 'flex';
            } else if (action === 'addCoins') {
                document.getElementById('add-coins-input').value = '';
                document.getElementById('add-coins-popup').style.display = 'flex';
            } else if (action === 'subtractCoins') {
                document.getElementById('subtract-coins-input').value = '';
                document.getElementById('subtract-error').style.display = 'none';
                document.getElementById('subtract-coins-popup').style.display = 'flex';
            } else if (action === 'delete') {
                document.getElementById('delete-confirm-popup').style.display = 'flex';
            }
        }

        function confirmBan(confirm) {
            document.getElementById('ban-confirm-popup').style.display = 'none';
            if (confirm) {
                document.getElementById('ban-message-input').value = '';
                document.getElementById('ban-message-popup').style.display = 'flex';
            } else {
                resetUserSelect();
            }
        }

        async function submitBanMessage() {
            const banMessage = document.getElementById('ban-message-input').value.trim();
            if (!selectedUserId || !db) return;

            const userRef = db.collection('users').doc(selectedUserId);
            await userRef.update({
                isBanned: true,
                banMessage: banMessage || 'No reason provided.'
            });
            document.getElementById('ban-message-popup').style.display = 'none';
            resetUserSelect();
        }

        function confirmUnban(confirm) {
            document.getElementById('unban-confirm-popup').style.display = 'none';
            if (confirm) {
                document.getElementById('unban-message-input').value = '';
                document.getElementById('unban-message-popup').style.display = 'flex';
            } else {
                resetUserSelect();
            }
        }

        async function submitUnbanMessage() {
            const unbanMessage = document.getElementById('unban-message-input').value.trim();
            if (!selectedUserId || !db) return;

            const userRef = db.collection('users').doc(selectedUserId);
            await userRef.update({
                isBanned: false,
                banMessage: 'No reason provided.',
                unbanMessage: unbanMessage || 'Welcome back!',
                shownUnbanMessage: false
            });
            document.getElementById('unban-message-popup').style.display = 'none';
            resetUserSelect();
        }

        async function submitAddCoins() {
            const amount = parseInt(document.getElementById('add-coins-input').value);
            if (!selectedUserId || !db || isNaN(amount) || amount <= 0) {
                document.getElementById('add-coins-popup').style.display = 'none';
                resetUserSelect();
                return;
            }

            const userRef = db.collection('users').doc(selectedUserId);
            const userDoc = await userRef.get();
            const userData = userDoc.data();
            const newCoins = (userData.coins || 0) + amount;
            await userRef.update({ coins: newCoins });
            updateLiveCoins(selectedUserId, newCoins);

            // Add transaction to history
            await userRef.update({
                transactionHistory: firebase.firestore.FieldValue.arrayUnion({
                    type: 'Credit',
                    amount: amount,
                    reason: 'Admin Added',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                })
            });

            document.getElementById('add-coins-popup').style.display = 'none';
            resetUserSelect();
        }

        async function submitSubtractCoins() {
            const amount = parseInt(document.getElementById('subtract-coins-input').value);
            if (!selectedUserId || !db || isNaN(amount) || amount <= 0) {
                document.getElementById('subtract-coins-popup').style.display = 'none';
                resetUserSelect();
                return;
            }

            const userRef = db.collection('users').doc(selectedUserId);
            const userDoc = await userRef.get();
            const userData = userDoc.data();
            const currentCoins = userData.coins || 0;

            if (currentCoins === 0 || amount > currentCoins) {
                document.getElementById('subtract-error').style.display = 'block';
                return;
            }

            const newCoins = currentCoins - amount;
            await userRef.update({ coins: newCoins });
            updateLiveCoins(selectedUserId, newCoins);

            // Add transaction to history
            await userRef.update({
                transactionHistory: firebase.firestore.FieldValue.arrayUnion({
                    type: 'Debit',
                    amount: amount,
                    reason: 'Admin Subtracted',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                })
            });

            document.getElementById('subtract-coins-popup').style.display = 'none';
            resetUserSelect();
        }

        function confirmDelete(confirm) {
            document.getElementById('delete-confirm-popup').style.display = 'none';
            if (confirm) {
                deleteUser();
            } else {
                resetUserSelect();
            }
        }

        async function deleteUser() {
            if (!selectedUserId || !db) return;
            const userRef = db.collection('users').doc(selectedUserId);
            await userRef.delete();
            console.log(`User ${selectedUserId} deleted successfully.`);
            resetUserSelect();
        }

        function updateLiveCoins(userId, coins) {
            const coinElement = document.getElementById(`coin-${userId}`);
            if (coinElement) {
                coinElement.textContent = coins;
            }
        }

        function resetUserSelect() {
            if (selectedUserId) {
                const select = document.getElementById(`user-select-${selectedUserId}`);
                if (select) select.value = '';
            }
            selectedUserId = null;
            selectedAction = null;
        }

        function updateSelectedWithdraw(withdrawId, action) {
            selectedWithdrawId = withdrawId;
            if (action === 'pay') {
                updateWithdrawStatus('Paid');
            } else if (action === 'cancel') {
                document.getElementById('cancel-reason-input').value = '';
                document.getElementById('cancel-reason-popup').style.display = 'flex';
            }
        }

        async function updateWithdrawStatus(status) {
            if (!selectedWithdrawId || !db) return;
            const withdrawRef = db.collection('withdraw_requests').doc(selectedWithdrawId);
            const withdrawDoc = await withdrawRef.get();
            const withdrawData = withdrawDoc.data();
            await withdrawRef.update({ status });

            const userRef = db.collection('users').doc(withdrawData.telegramId.toString());
            const userDoc = await userRef.get();
            const userData = userDoc.data();
            const updatedHistory = userData.withdrawalHistory.map(w => {
                if (w.timestamp === withdrawData.timestamp.toDate().toISOString()) {
                    return { ...w, status };
                }
                return w;
            });
            await userRef.update({ withdrawalHistory: updatedHistory });
            selectedWithdrawId = null;
        }

        async function submitCancelReason() {
            const cancelReason = document.getElementById('cancel-reason-input').value.trim();
            if (!selectedWithdrawId || !db) return;

            const withdrawRef = db.collection('withdraw_requests').doc(selectedWithdrawId);
            const withdrawDoc = await withdrawRef.get();
            const withdrawData = withdrawDoc.data();
            await withdrawRef.update({ status: 'Cancelled' });

            const userRef = db.collection('users').doc(withdrawData.telegramId.toString());
            const userDoc = await userRef.get();
            const userData = userDoc.data();
            const updatedHistory = userData.withdrawalHistory.map(w => {
                if (w.timestamp === withdrawData.timestamp.toDate().toISOString()) {
                    return { ...w, status: 'Cancelled', cancelReason: cancelReason || 'No reason provided.' };
                }
                return w;
            });

            const newCoins = (userData.coins || 0) + withdrawData.amount;
            await userRef.update({
                coins: newCoins,
                withdrawalHistory: updatedHistory
            });

            // Add transaction to history
            await userRef.update({
                transactionHistory: firebase.firestore.FieldValue.arrayUnion({
                    type: 'Credit',
                    amount: withdrawData.amount,
                    reason: 'Withdrawal Cancelled',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                })
            });

            document.getElementById('cancel-reason-popup').style.display = 'none';
            selectedWithdrawId = null;
        }

        function cancelAction() {
            document.getElementById('add-coins-popup').style.display = 'none';
            document.getElementById('subtract-coins-popup').style.display = 'none';
            document.getElementById('cancel-reason-popup').style.display = 'none';
            resetUserSelect();
        }

        async function updateDashboardSummary() {
            if (!db) return;
            const usersSnapshot = await db.collection('users').get();
            const withdrawSnapshot = await db.collection('withdraw_requests').get();

            let totalUsers = usersSnapshot.size;
            let totalCoins = 0;
            let pendingWithdrawals = 0;

            usersSnapshot.forEach(doc => {
                const user = doc.data();
                totalCoins += user.coins || 0;
            });

            withdrawSnapshot.forEach(doc => {
                const withdraw = doc.data();
                if (withdraw.status === 'Pending') {
                    pendingWithdrawals++;
                }
            });

            document.getElementById('total-users').textContent = totalUsers;
            document.getElementById('total-coins').textContent = totalCoins;
            document.getElementById('pending-withdrawals').textContent = pendingWithdrawals;
        }

        async function sendNotice() {
            if (!isAdminAuthenticated || !db) {
                document.getElementById('notice-status').textContent = 'Access denied: Admin only.';
                return;
            }
            const noticeMessage = document.getElementById('admin-notice').value.trim();
            if (!noticeMessage) {
                document.getElementById('notice-status').textContent = 'Please enter a notice message.';
                return;
            }

            const usersSnapshot = await db.collection('users').get();
            const batch = db.batch();
            usersSnapshot.forEach(doc => {
                const userRef = db.collection('users').doc(doc.id);
                batch.update(userRef, {
                    notices: firebase.firestore.FieldValue.arrayUnion({
                        message: noticeMessage,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    })
                });
            });

            await batch.commit();
            document.getElementById('notice-status').textContent = 'Notice sent to all users!';
            document.getElementById('admin-notice').value = '';
        }

        async function testFirestoreWrite() {
            if (!db) {
                document.getElementById('admin-access-message').textContent = 'Database not initialized.';
                return;
            }
            const testUserId = `testUser_${testUserCounter++}`;
            const testUserRef = db.collection('users').doc(testUserId);
            try {
                await testUserRef.set({
                    telegramId: testUserId,
                    username: `TestUser${testUserCounter}`,
                    coins: 100,
                    referralLink: `${baseReferralUrl}test${testUserId}`,
                    invitedUsers: [],
                    isBanned: false,
                    banMessage: '',
                    unbanMessage: '',
                    shownUnbanMessage: false,
                    withdrawalHistory: [],
                    notices: [],
                    shownNotices: [],
                    hasJoinedBot: true,
                    referralEvents: [],
                    transactionHistory: [],
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('admin-access-message').textContent = `Test user ${testUserId} created with 100 coins.`;
            } catch (error) {
                console.error('Firestore write test failed:', error);
                document.getElementById('admin-access-message').textContent = 'Firestore write test failed: ' + error.message;
            }
        }

        function checkAdminPassword() {
            const password = document.getElementById('admin-password').value;
            if (password === adminPassword) {
                isAdminAuthenticated = true;
                document.getElementById('admin-popup').style.display = 'none';
                showPage('admin');
                loadAdminPanel();
                document.getElementById('nav').classList.add('admin-active');
            } else {
                document.getElementById('admin-error').style.display = 'block';
            }
        }

        function updateProfile(userData) {
            document.getElementById('profile-username').textContent = `Username: ${userData.username || 'Anonymous'}`;
            document.getElementById('profile-id').textContent = `Telegram ID: ${userData.telegramId}`;
            document.getElementById('profile-joined').textContent = `Joined: ${userData.joinedAt?.toDate().toLocaleString() || 'Unknown'}`;
            document.getElementById('profile-referral').textContent = `Referral Link: ${userData.referralLink}`;
        }

        async function loadProfile() {
            if (!currentUser || !db) return;
            const userRef = db.collection('users').doc(currentUser.id.toString());
            const userDoc = await userRef.get();
            const userData = userDoc.data();
            updateProfile(userData);

            const transactionHistory = document.getElementById('transaction-history');
            transactionHistory.innerHTML = '';
            const transactions = userData.transactionHistory || [];
            if (transactions.length === 0) {
                transactionHistory.innerHTML = '<p>No transactions yet.</p>';
            } else {
                transactions.forEach(tx => {
                    const txItem = document.createElement('p');
                    txItem.textContent = `${tx.type}: ${tx.amount} coins - ${tx.reason} on ${tx.timestamp.toDate().toLocaleString()}`;
                    transactionHistory.appendChild(txItem);
                });
            }
        }

        async function refreshData() {
            if (!currentUser || !db) {
                document.getElementById('admin-access-message').textContent = 'Database or user not initialized.';
                return;
            }

            document.getElementById('loading').style.display = 'flex';
            try {
                const userRef = db.collection('users').doc(currentUser.id.toString());
                const userDoc = await userRef.get();
                const userData = userDoc.data();
                if (!userData) return;

                // Update balance page
                balance = userData.coins || 0;
                document.getElementById('balance-amount').textContent = `${balance} Coins`;

                // Update invite page
                friendsInvited = userData.invitedUsers ? userData.invitedUsers.length : 0;
                document.getElementById('referral-link').textContent = `Your referral link: ${userData.referralLink}`;
                document.getElementById('friends-invited').textContent = `Friends Invited: ${friendsInvited}`;

                // Update profile page
                updateProfile(userData);
                await loadProfile();

                // Check for new notices
                await checkForNotices();

                // Check withdrawal status
                await checkWithdrawStatus();

                // Update admin panel if admin is authenticated
                if (isAdminAuthenticated) {
                    await updateDashboardSummary();
                    await loadAdminPanel();
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                document.getElementById('admin-access-message').textContent = 'Error refreshing data: ' + error.message;
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        window.addEventListener('load', async () => {
            await initializeFirebase();
            const telegramInitialized = initTelegram();
            if (telegramInitialized) {
                document.getElementById('loading').style.display = 'none';
            }
        });

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    </script>
</body>
</html>
